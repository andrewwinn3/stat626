---
title: "University of Michigan: Consumer Sentiment (Report 2)"
author: "Group 3: Michelle Nguyen, Jerden Daniels, Cassandra Garner, Eli Hymson, Andrew Winn"
output: word_document
---

```{r setup}
knitr::opts_knit$set(root.dir = "~/STAT626/stat626/Data") #Set to your Data directory

library(tidyverse)
library(readr)
library(TSstudio)
library(xts)
library(quantmod)
library(forecast)
library(tis)
library(gridExtra)
library(timeDate)
```

```{r}
# Functionally identical to Presentation1.Rmd

# 'UMCSENT2.csv' is the FRED file trimed from the first observation of 1978
umcsent <- read_csv(file = 'UMCSENT2.csv')
umcsent.df <- data.frame(
   DATE <- as.Date(umcsent$DATE),
   UMCSENT = as.numeric(umcsent$UMCSENT))

unrate = getSymbols('UNRATE',src='FRED', auto.assign = F, from = "1978-01-01" , to = "2020-05-01") 
unrate.df = data.frame(date=time(unrate), coredata(unrate))
recessions.df = read.table(textConnection(
"Peak, Trough
1873-10-01, 1879-03-01
1882-03-01, 1885-05-01
1887-03-01, 1888-04-01
1890-07-01, 1891-05-01
1893-01-01, 1894-06-01
1895-12-01, 1897-06-01
1899-06-01, 1900-12-01
1902-09-01, 1904-08-01
1907-05-01, 1908-06-01
1910-01-01, 1912-01-01
1913-01-01, 1914-12-01
1918-08-01, 1919-03-01
1920-01-01, 1921-07-01
1923-05-01, 1924-07-01
1926-10-01, 1927-11-01
1929-08-01, 1933-03-01
1937-05-01, 1938-06-01
1945-02-01, 1945-10-01
1948-11-01, 1949-10-01
1953-07-01, 1954-05-01
1957-08-01, 1958-04-01
1960-04-01, 1961-02-01
1969-12-01, 1970-11-01
1973-11-01, 1975-03-01
1980-01-01, 1980-07-01
1981-07-01, 1982-11-01
1990-07-01, 1991-03-01
2001-03-01, 2001-11-01
2007-12-01, 2009-06-01"), sep=',',
colClasses=c('Date', 'Date'), header=TRUE)

recessions.trim = subset(recessions.df, Peak >= min(unrate.df$date) )
Yt = ts(umcsent$UMCSENT, frequency = 12, start = c(1978,1))

# UMCSENT separated by components
comp = read.csv("UMCSENT_COMPONENTS.csv")
comp$DATE = as.Date(paste(comp$Year, comp$Month, "01", sep="-"))
```

```{r}
# Perform lag 1 differencing
umcsent.df = data.frame(umcsent.df, LAG1 = c(NA, diff(umcsent$UMCSENT,1)))
colnames(umcsent.df)[1] = "DATE"

ggplot(data=umcsent.df) +
  geom_line(aes(x=DATE, y=LAG1))

# Residual plots suggest normality, homosketasticity, and constant mean. (see below)
# Moreover, the intercept of the differenced series is not significant, suggesting
#    that the original series has no general trend.
lag1lm = lm(LAG1 ~ DATE, data = umcsent.df)
plot(lag1lm)
summary(lag1lm)

# The Dickey-Fuller test supports stationarity of lag 1 transformation at p < 0.01
aTSA::adf.test(umcsent.df$LAG1)
```  
The at first glance the residuals seem to have approximately constant variance. However, we see that there are regions with higher error variance, which corresponds to increased volatility in the original series. These regions are certainly worth noting, but the nonuniformity of noise variances is minor enough that it is likely permissible to ignore.

```{r}
# Repeat these procedures with comp, the dataframe of component series.
# Abbreviations:
# PFC: current personal finance conditions
# PFE: personal finance expectations (12 months)
# BC12: business conditions (12 months)
# BC5: business conditions (5 years)
# BC: current buying conditions
comp$PFC.LAG1 = c(NA, diff(comp$Personal.Finance.Current,1))
comp$PFE.LAG1 = c(NA, diff(comp$Personal.Finance.Expected,1))
comp$BC12.LAG1 = c(NA, diff(comp$Business.Condition.12.Months,1))
comp$BC5.LAG1 = c(NA, diff(comp$Business.Condition.5.Years,1))
comp$BC.LAG1 = c(NA, diff(comp$Buying.Conditions,1))

# Restructures comp dataframe to allow for use of faceting
comp.facet = data.frame(DATE=rep(comp$DATE, 5),
                        COMPONENT=rep(c('PFC', 'PFE', 'BC12', 'BC5', 'BC'), each=nrow(comp)),
                        INDEX=c(comp$PFC.LAG1, comp$PFE.LAG1, comp$BC12.LAG1, comp$BC5.LAG1, comp$BC.LAG1))

# Plots lag 1 differencing of components
ggplot(data=comp.facet) + 
  geom_line(aes(x=DATE, y=INDEX)) + 
  facet_grid(COMPONENT~.)

# Check residuals and slope estimates when viewing series as linear models.
# Note that since components take strictly integer values, we'll have some natural
#    clustering, but that is okay.
PFC.lm = lm(PFC.LAG1 ~ DATE, data=comp)
PFE.lm = lm(PFE.LAG1 ~ DATE, data=comp)
BC12.lm = lm(BC12.LAG1 ~ DATE, data=comp)
BC5.lm = lm(BC5.LAG1 ~ DATE, data=comp)
BC.lm = lm(BC.LAG1 ~ DATE, data=comp)

summary(PFC.lm)
plot(PFC.lm)

summary(PFE.lm)
plot(PFE.lm)

summary(BC12.lm)
plot(BC12.lm)

summary(BC5.lm)
plot(BC5.lm)

summary(BC.lm)
plot(BC.lm)

# Dickey-Fuller tests suggest alternative hypothesis of stationarity at p<0.01
aTSA::adf.test(comp$PFC.LAG1)
aTSA::adf.test(comp$PFE.LAG1)
aTSA::adf.test(comp$BC12.LAG1)
aTSA::adf.test(comp$BC5.LAG1)
aTSA::adf.test(comp$BC.LAG1)
```  

The reasonable conclusions for individual components are essentially the same as for the UMCSENT index as a whole. We have the desired normality and regularity assumptions excpet for some (arguably insignificant) regions of volatility in which noise variance increases slightly. (Note that this seems most extreme in the 'buying conditions' series, so any further investigation should begin there. That is also the series for which the assumption of constant mean had the least evidence, although the evidence is still sufficiently strong.) The Dickey-Fuller tests for non-stationarity all return p-values less than 0.01, so it is reasonable to proceed under the assumptions that the lag 1 difference series are stationary.







